<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Comparador Consumo Actual vs Histórico</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
  <div class="container my-4">
    <h1>Comparador de Consumo</h1>

    <!-- Botón para actualizar datos: bandera de España -->
    <a href="{{ url_for('update_consumo') }}"
       class="btn mb-4"
       style="
         background: linear-gradient(
           to right,
           #AA151B 0%, #AA151B 33%,
           #F1BF00 33%, #F1BF00 66%,
           #AA151B 66%, #AA151B 100%
         );
         color: white;
         border: 1px solid #AA151B;
       ">
      Actualizar Consumo
    </a>

    <!-- Formulario -->
    <form method="post" action="{{ url_for('show_consumption') }}" class="form-inline mb-4">
      <label for="pais" class="mr-2">País:</label>
      <select id="pais" name="pais" class="form-control mr-3">
        {% for p in paises %}
          <option value="{{ p }}" {% if datos and datos.pais == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>

      <label for="indicador" class="mr-2">Indicador:</label>
      <select id="indicador" name="indicador" class="form-control mr-3">
        {% for i in indicadores %}
          <option value="{{ i }}" {% if datos and datos.indicador == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>

      <label for="anio" class="mr-2">Año histórico:</label>
      <select id="anio" name="anio" class="form-control mr-3">
        <option value="">(último disponible)</option>
        {% for y in anios %}
          <option value="{{ y }}" {% if datos and datos.fecha_actual.year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary">Comparar</button>
    </form>

    <!-- Resultados específicos -->
    {% if datos %}
      <h2>Resultados para {{ datos.pais }} — {{ datos.indicador }}</h2>
      <p>Fecha actual: {{ datos.fecha_actual.strftime('%Y-%m-%d') }}</p>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Actual</th>
            <th>Histórico ({{ datos.fecha_actual.year }})</th>
            <th>Diferencia</th>
          </tr>
        </thead>
        <tbody>
          {% for key, val in datos.valores_actual.items() %}
            {% set hist = datos.valores_historico[key] if datos.valores_historico else None %}
            <tr>
              <td>{{ key.replace('_',' ').capitalize() }}</td>
              <td>{{ val }}</td>
              <td>{{ hist or '—' }}</td>
              <td>{{ hist is not none and (val - hist) or 'N/A' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    <!-- Todos los consumos actuales -->
    {% if actual_list %}
      <h3>Todos los consumos actuales registrados</h3>
      <table class="table table-sm table-striped mb-4">
        <thead>
          <tr>
            <th>País</th><th>Indicador</th><th>Fecha</th><th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for a in actual_list %}
            <tr>
              <td>{{ a.pais }}</td>
              <td>{{ a.indicador }}</td>
              <td>
                {% if a.fecha_parsed %}
                  {{ a.fecha_parsed.strftime('%Y-%m-%d') }}
                {% else %}
                  {{ a.fecha[:10] }}
                {% endif %}
              </td>
              <td>{{ a.total }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    <!-- Todos los históricos -->
    {% if historico_list %}
      <h3>Todos los registros históricos</h3>
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>País</th><th>Indicador</th><th>Año</th><th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for h in historico_list %}
            <tr>
              <td>{{ h.pais }}</td>
              <td>{{ h.indicador }}</td>
              <td>{{ h.anio }}</td>
              <td>{{ h.total }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

  </div>
</body>
</html>